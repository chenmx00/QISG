import tushare as ts
import db

CODE_LIST = [
    "600020", "600021", "600022", "600023", "600025", "600026", "600027",
    "600028", "600029", "600030", "600031", "600033", "600035", "600036",
    "600037", "600038", "600039", "600048", "600050", "600051", "600052",
    "600053", "600054", "600055", "600056", "600057", "600058", "600059",
    "600060", "600061", "600062", "600063", "600064", "600066", "600067",
    "600068", "600069", "600070", "600071", "600072", "600073", "600075",
    "600076", "600077", "600078", "600079", "600080", "600081", "600082",
    "600083", "600084", "600085", "600086", "600088", "600089", "600090",
    "600093", "600094", "600095", "600096", "600097", "600098", "600099",
    "600100", "600101", "600103", "600104", "600105", "600106", "600107",
    "600108", "600109", "600110", "600111", "600113", "600114", "600115",
    "600116", "600117", "600118", "600119", "600120", "600122", "600123",
    "600125", "600126", "600127", "600128", "600129", "600130", "600131",
    "600132", "600133", "600135", "600136", "600137", "600138", "600139",
    "600141", "600143", "600146", "600148", "600150", "600151", "600152",
    "600153", "600155", "600156", "600157", "600158", "600159", "600160",
    "600161", "600162", "600163", "600165", "600166", "600167", "600168",
    "600169", "600170", "600171", "600172", "600173", "600175", "600176",
    "600177", "600178", "600179", "600180", "600182", "600183", "600184",
    "600185", "600186", "600187", "600188", "600189", "600190", "600191",
    "600192", "600193", "600195", "600196", "600197", "600198", "600199",
    "600200"
]


def fetch(code_list):
    tsconn = ts.get_apis()
    sqlconn = db.connect()
    cursor = sqlconn.cursor()

    try:
        for code in code_list:
            try:
                data = ts.bar(
                    code, conn=tsconn, start_date="1970-01-01", freq="5min")

                count = data.shape[0]
                i = 0

                for index, row in data.iterrows():
                    cursor.execute(
                        "insert into stock_price (code, time, price) values (%s, %s, %s)",
                        (code, str(index), float(row["close"])))
                    i += 1
                    if i % 1000 == 0:
                        print("{0} {1}%".format(code, int(i / count * 100)))
                        
                sqlconn.commit()
                print("done")
                
            except IOError as err:

                print(code)
                print(err)

            
        
    finally:
        sqlconn.close()
        ts.close_apis(tsconn)


if __name__ == "__main__":
    fetch(CODE_LIST)